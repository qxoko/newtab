<!DOCTYPE html>
<html>
<head>
	<title>New Tab</title>
	<style type="text/css">
		@font-face {
			src: url('~/roboto_mono_regular.ttf');
			font-family: roboto;
		}

		:root {
			--bcolor: #1F2021;
			--fcolor: #DDD;
			--halftn: #666;
			--R: #EC095A;
			--Y: #FFC914;
			--B: #17BEBB;
		}

		body {
			font-family: roboto, monospace;
			background-color: var(--bcolor);
			color:            var(--fcolor);
			font-size: 16px;
		}

		#title_text {
			position: absolute;
			top: 50px;
			left: 50px;
			color: var(--fcolor);
		}

		#time {
			position: absolute;
			top: 50px;
			right: 50px;
			color: var(--R);
		}

		#message {
			position: absolute;
			left: 150px;
			top: 50px;
			color: var(--halftn);
		}

		#input {
			font-family: roboto, monospace;
			color:       var(--fcolor);
			position: absolute;
			top: 100px;
			left: 50px;
			font-size:   16px;
			width:       80%;
			background:  none;
			border:      none;
			outline:     none;
			margin:      none;
		}

		::-moz-selection {
			color:      var(--bcolor);
			background: var(--fcolor);
		}

		::selection {
			color:      var(--bcolor);
			background: var(--fcolor);
		}
	</style>
</head>
<body>
	<div id="title_text">search</div>
	<div id="time">000|000</div>
	<input id="input" type="text" autofocus autocomplete="off" spellcheck="false" autocapitalize="none" autocorrect="off">
	<div id="message"></div>
	<script type="text/javascript">
		// default command if no command is specified
		let default_command = 'g';
		let last_command	= null;

		function get_weird_date() {
			var now   = new Date();
			var start = new Date(now.getFullYear(), 0, 0);
			var day   = Math.floor(((now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000)) / (1000 * 60 * 60 * 24));
			return (now.getFullYear() - 2000) * 1000 + day;
		}

		function focus_input() {
			document.querySelector('#input').select();
		}

		function handle_keypress(k) {
			let keycode = k.which || k.keyCode;

			if (keycode === 13) { // return key
				evaluate_input();
				return;
			}

			if (keycode === 38) { // up key
				document.querySelector('#input').value = last_command;
				return;
			}

			let buffer  = document.querySelector('#input').value;
			let command = buffer.match(/\S*/);

			if (command_name.hasOwnProperty(command)) {
				document.querySelector('#message').innerText = command_name[command];
			} else {
				document.querySelector('#message').innerText = '';
			}
		}

		window.onload = () => {
			// assign time
			document.querySelector('#time').innerHTML = get_weird_date();
			document.onkeyup = handle_keypress;

			// focus the text box
			document.querySelector('html').addEventListener('click', focus_input);
			focus_input();
		}

		function build_url(url, search='', query='') {
			let dest = (/(http(s)?:\/\/.)/.test(url)) ? url : 'http://' + url;
			return dest + search + encodeURIComponent(query);
		}

		function go_to_site(url, search, arg='') {
			if (arg) {
				redirect(build_url(url, search, arg));
			} else {
				redirect(url);
			}
		}

		function redirect(url) {
			window.location.href = url;
			return false;
		}

		function is_url(url) {
			if (/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/.test(url)) {
				if (!url.includes(' ')) {
					return true;
				}
			}
			return false;
		}

		function evaluate_input() {
			let input_box = document.querySelector('#input');
			let buffer    = input_box.value.trim().toLowerCase();

			if (buffer === '') { return; }

			last_command = buffer;

			if (is_url(buffer)) {
				redirect(build_url(buffer));
				input_box.value = '';
				return;
			}

			let command = buffer.match(/\S*/);

			if (command_list.hasOwnProperty(command)) {
				command_list[command](buffer.replace(command,'').trim());
			} else {
				command_list[default_command](buffer);
			}

			input_box.value = '';
		}

		const command_name = {
			'x':    'redirect',
			'g':    'google',
			'img':  'google images',
			'y':    'youtube',
			'n':    'netflix',
			'r':    'reddit',
			't':    'tumblr',
			'tw':   'twitter',
			'w':    'wikipedia',
			'a':    'amazon',
			'git':  'github',
			'd':    'discord',
			'dict': 'dictionary',
			'thes': 'thesaurus',
			'm':    'protonmail',
			's':    'slack',
			'dots': 'dotfiles',
			'tr':   'google translate'
		}

		const command_list = {
			// force redirect
			'x': (url) => {
				redirect('https://' + url)
			},
			// google proper
			'g': (query) => {
				go_to_site('https://google.com', '/search?q=', query);
			},
			// google images
			'img': (query) => {
				go_to_site('https://google.com', '/search?tbm=isch&q=', query);
			},
			// youtube
			'y': (query) => {
				if (query === 's') {
					redirect('https://www.youtube.com/feed/subscriptions');
				} else {
					go_to_site('https://youtube.com', '/results?search_query=', query);
				}
			},
			// netflix
			'n': (query) => {
				go_to_site('https://netflix.com', '/search?q=', query);
			},
			// reddit + subreddit as arg
			'r': (sub) => {
				go_to_site('https://reddit.com', '/r/', sub);
			},
			// tumblr + blog url as arg
			't': (blog) => {
				if (blog) {
					redirect('https://' + blog + '.tumblr.com/');
				} else {
					redirect('https://tumblr.com/dashboard');
				}
			},
			'tw': (query) => {
				go_to_site('https://twitter.com', '/search?q=', query);
			},
			// wikipedia
			'w': (query) => {
				go_to_site('https://wikipedia.org', '/w/index.php?tile=Special:Search&search=', query);
			},
			// github
			'git': (query) => {
				go_to_site('https://github.com', '/search?q=', query);
			},
			// discord web
			'd': () => {
				go_to_site('https://discordapp.com/app');
			},
			// dictionary.com
			'dict': (query) => {
				go_to_site('https://dictionary.com', '/browse/', query);
			},
			// thesaurus.com
			'thes': (query) => {
				go_to_site('https://thesaurus.com', '/browse/', query);
			},
			// amazon
			'a': (query) => {
				go_to_site('https://amazon.co.uk', '/s/?field-keywords=', query);
			},
			// protonmail
			'm': () => {
				redirect('https://mail.protonmail.com/inbox')
			},
			// slack
			's': (workspace) => {
				if (workspace) {
					redirect('https://' + workspace + '.slack.com/');
				} else {
					redirect('https://slack.com/');
				}
			},
			'translate': () => {
				redirect('https://translate.google.com');
			},
			'dots': (directory) => {
				go_to_site('https://github.com/qxoko/dots', '/tree/master/', directory);
			}
		}
	</script>
</body>
</html>